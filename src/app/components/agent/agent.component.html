<div class="header">
    <div class="buttons">
        <button mat-button (click)="homeButtonEvent()">Home</button>
        <button class="button" style="border: 50%;
        width: 43px;
        height: 43px;
        background-size: cover;" [ngStyle]="{'background-image': 'url(../../../assets/pngegg.png)'}" [matMenuTriggerFor]="menu"></button>      
    </div>
</div>

<mat-menu #menu="matMenu">
    <span style="margin: 0px 16px;">Hi, {{username}}!</span>
    <div style="margin-top: 10px;">
        <button class="default-button" mat-menu-item (click)=logout()>
            <mat-icon>logout</mat-icon>
            Logout</button>
    </div>
  </mat-menu>

<div class="main">

    <h1>Welcome {{username}}</h1>

    <div class="customers">
        <mat-button-toggle-group name="fontStyle" aria-label="Font Style" class="tabs">
            <mat-button-toggle (click)="tabSwitch('customer')" [checked]="tab === 'customer'" class="toggle">Browse customers</mat-button-toggle>
            <mat-button-toggle (click)="tabSwitch('policy')" [checked]="tab === 'policy'" class="toggle">Pending policies</mat-button-toggle>
            <mat-button-toggle (click)="tabSwitch('profile')" [checked]="tab === 'profile'" class="toggle">Profile</mat-button-toggle>
        </mat-button-toggle-group>

        <div *ngIf="tab === 'customer'; else pending">

            <div class="spinner" [style.display]="customerLoader">
                <mat-spinner></mat-spinner>
            </div>

            <div *ngIf="customers.length === 0 && customerLoader === 'none'" class="no-policies">
                <p>No customers were found.</p>
            </div>
            
            <div class="customer" *ngFor="let customer of customers">
                <pre>Name           :       {{customer.username}}</pre>
                <pre>Email          :       {{customer.email}}</pre>
                <pre>Age            :       {{customer.age}}</pre>
                <pre>Region         :       {{customer.region}}</pre>
                <pre>Phone number   :       {{customer.phno}}</pre>
                <button (click)="viewCustomerPolicies(customer._id)">View policies</button>

                <div class="details"
                [ngStyle]="{ 
                  'height': extendedCard === customer._id ? height : '0', 
                }">
                    <div *ngIf="customerPolicies.length !== 0; else noPolicy" class="customer">
                        <div *ngFor="let policy of customerPolicies" style="display: flex;
                        flex-direction: column;
                        justify-content: space-between;
                        background-color: rgb(220, 228, 237);
                        padding: 10px 30px 20px 30px;
                        margin-bottom: 20px;
                        border-radius: 30px;">
                            <div class="policy">
                                <pre>Policy name          :       {{policy.policyName}}</pre>
                                <pre>Premium amount       :       {{policy.premiumAmount}}</pre>
                                <pre>Policy duration      :       {{policy.duration}}</pre>
                                <pre>Policy coverage      :       {{policy.coverage}}</pre>
                                <pre>Premium paid         :       {{policy.premiumPaid}}</pre>
                                <pre>Policy start date    :       {{policy.policyStartDate | date: 'yyyy-MM-dd'}}</pre>
                                <pre>Policy status        :       {{policy.status}}</pre>
                                <pre>Pending Premium      :       {{policy.pendingPremium}}</pre>
                            </div>
                            <div style="display: flex;
                            gap: 10px;
                            margin-top: 5px;">
                                <button (click)="downloadPdf(policy.policyApplication.data)">View Application</button>
                                <button (click)="downloadPdf(policy.incomeProof.data)">Income Proof</button>
                                <button (click)="downloadPdf(policy.ageProof.data)">Age Proof</button>
                                <button (click)="downloadPdf(policy.idProof.data)">Identity Proof</button>
                            </div>
                        </div>
                    </div>                 
                    <ng-template #noPolicy>
                        <div style="display: flex;
                        justify-content: center;">
                            <h2 style="margin-top: 20px;">No policy found</h2>
                        </div>
                    </ng-template>
                </div>
            </div>
            <div class="pagination" *ngIf="customerLoader === 'none' && totalPages>1">              
                <button mat-button (click)="prevPage()" [disabled]="currentPage === 1">Previous</button>
                <span>Page {{currentPage}} of {{totalPages}}</span>
                <button mat-button (click)="nextPage()" [disabled]="currentPage === totalPages">Next</button>
            </div>
        </div>
        <ng-template #pending>
            <div *ngIf="tab === 'policy'; else profile">

                <div class="spinner" [style.display]="pendingPoliciesLoader">
                    <mat-spinner></mat-spinner>
                </div>

                <div *ngIf="pendingPolicies.length === 0 && pendingPoliciesLoader === 'none'" class="no-policies">
                      <p>No pending policies for approval are found.</p>
                </div>
                <div class="customer" *ngFor="let policy of pendingPolicies" style="display: flex;
                flex-direction: column;">
                    <div style="display: flex;
                    justify-content: space-between;
                    align-items: center;">
                        <div>
                            <pre>Customer name      :       {{policy.customerName}}</pre>
                            <pre>Customer email     :       {{policy.customerEmail}}</pre>
                            <pre>Policy name        :       {{policy.policyName}}</pre>
                            <pre>Premium amount     :       {{policy.premiumAmount}}</pre>
                            <pre>Policy duration    :       {{policy.duration}}</pre>
                            <pre>Policy coverage    :       {{policy.coverage}}</pre>
                        </div>
                        <div>
                            <button style="width: 150px;" (click)="forwardButton(policy._id)">Forward to admin</button>
                        </div>
                    </div>
                    <div style="display: flex;
                    gap: 10px;">
                        <button (click)="downloadPdf(policy.policyApplication.data)">View Application</button>
                        <button (click)="downloadPdf(policy.incomeProof.data)">Income Proof</button>
                        <button (click)="downloadPdf(policy.ageProof.data)">Age Proof</button>
                        <button (click)="downloadPdf(policy.idProof.data)">Identity Proof</button>
                    </div>
                </div>
                <div class="pagination" *ngIf="pendingPoliciesLoader === 'none' && pendingTotalPages>1">              
                  <button mat-button (click)="prevPage2()" [disabled]="pendingCurrentPage === 1">Previous</button>
                  <span>Page {{pendingCurrentPage}} of {{pendingTotalPages}}</span>
                  <button mat-button (click)="nextPage2()" [disabled]="pendingCurrentPage === pendingTotalPages">Next</button>
              </div>
            </div>
            
            <ng-template #profile>
                <div class="customer-profile">
              
                  <section class="profile-section">
                    <div class="profile-picture">
                      <!-- Dynamically show the profile picture -->
                      <img [src]="profilePicUrl" alt="Profile Picture" *ngIf="profilePicUrl" />
                      <p *ngIf="!profilePicUrl">No profile picture available</p>
                    </div>
                    <div class="profile-info">
                      <form #profileFrom="ngForm">
                        <!-- Username Field -->
                        <div class="form-group">
                          <label for="username">Username:</label>
                          <span *ngIf="!isEditing">{{ agent.username }}</span>
                          <input
                            *ngIf="isEditing"
                            id="username"
                            [(ngModel)]="agent.username"
                            name="username"
                            required
                          />
                        </div>
                        <div class="form-group">
                          <label for="gender">Gender:</label>
                          <span *ngIf="!isEditing">{{ agent?.gender || 'No gender provided' }}</span>
                          <select 
                            *ngIf="isEditing" 
                            id="gender" 
                            [(ngModel)]="agent.gender" 
                            name="gender" class="gender">
                            <option *ngIf="agent?.gender" [value]="agent.gender">{{ agent.gender }}</option>
                            <option *ngIf="!agent.gender" value="">Select Gender</option>
                            <option value="Male" *ngIf="agent?.gender !== 'Male'">Male</option>
                            <option value="Female" *ngIf="agent?.gender !== 'Female'">Female</option>
                            <option value="Other" *ngIf="agent?.gender !== 'Other'">Other</option>
                          </select>
                        </div>                
                        <!-- Email Field -->
                        <div class="form-group">
                          <label for="email">Email:</label>
                          <span *ngIf="!isEditing">{{ agent.email }}</span>
                          <input
                            *ngIf="isEditing"
                            id="email"
                            [(ngModel)]="agent.email"
                            name="email"
                            type="email"
                            required
                          />
                        </div>
              
                        <!-- Phone Field -->
                        <div class="form-group">
                          <label for="phone">Phone:</label>
                          <span *ngIf="!isEditing">{{ agent.phno }}</span>
                          <input
                            *ngIf="isEditing"
                            id="phone"
                            [(ngModel)]="agent.phno"
                            name="phone"
                            type="tel"
                          />
                        </div>
              
                        <!-- Region Field -->
                        <div class="form-group">
                          <label for="region">Region:</label>
                          <span *ngIf="!isEditing">{{ agent.region }}</span>
                          <input
                            *ngIf="isEditing"
                            id="region"
                            [(ngModel)]="agent.region"
                            name="region"
                          />
                        </div>
              
                        <!-- Number of Customers Field -->
                        <div class="form-group">
                          <label for="num_of_customers">Number of Customers:</label>
                          <span>{{ agent.num_of_customers }}</span>
                        </div>
              
                        <!-- Number of Policies Field -->
                        <div class="form-group">
                          <label for="num_of_policies">Number of Policies:</label>
                          <span>{{ agent.num_of_policies }}</span>
                        </div>
              
                        <!-- Commission Field -->
                        <div class="form-group">
                          <label for="commission">Commission:</label>
                          <span>{{ agent.commission }}</span>
                        </div>
                      </form>
                    </div>
                  </section>
              
                  <div class="profile-actions">
                    <button (click)="toggleEditMode()" class="edit-button">
                      {{ isEditing ? 'Cancel' : 'Edit' }}
                    </button>
              
                  <!-- Save Changes Button -->
                    <button *ngIf="isEditing" class="SaveButton"
                      [disabled]="!profileFrom.valid" 
                      (click)="saveChanges()">
                      Save
                    </button>
                </div>
                </div>
              </ng-template>              
        </ng-template>
    </div>

    <div class="footer">

    </div>
</div>